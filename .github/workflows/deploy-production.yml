name: Deploy to Fly.io Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual deployment from GitHub UI

# Prevent concurrent deployments to production
concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    # Optional: Use GitHub environment for additional protection
    environment:
      name: production
      url: https://vikram-portfolio.fly.dev # Update with your actual URL

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}

      - name: Verify deployment
        run: |
          echo "üöÄ Deployment completed!"
          echo "üîç Checking app status..."
          flyctl status
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Run smoke tests
        run: |
          echo "üß™ Running smoke tests..."
          APP_URL="https://vikram-portfolio.fly.dev" # Update with your actual URL

          # Wait for deployment to be ready
          sleep 10

          # Check if app responds
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)

          if [ $HTTP_CODE -eq 200 ]; then
            echo "‚úÖ App is responding with HTTP $HTTP_CODE"
          else
            echo "‚ùå App returned HTTP $HTTP_CODE"
            exit 1
          fi
        continue-on-error: true # Don't fail deployment if smoke test fails

      # Optional: Send deployment notification to Slack/Discord
      # - name: Send deployment notification
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: "Portfolio deployed to production"
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
